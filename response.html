<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1"/>
  <title>Seva Registration ‚Äî ISKCON Centre Orai</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --saffron:#E8762B; --saffron-d:#C4581A; --saffron-l:#FDF0E6;
      --gold:#C9922A; --gold-l:#FBF3E0;
      --cream:#FDFAF4; --ink:#1C1608; --muted:#7A6A50;
      --border:#E8DFC8; --white:#FFFFFF;
      --green:#2D6A3F; --green-l:#E8F5ED;
    }
    body {
      font-family:'Jost',sans-serif; background:var(--cream); color:var(--ink);
      min-height:100vh; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      padding:40px 20px;
    }
    .top-band {
      position:fixed; top:0; left:0; right:0;
      background:linear-gradient(135deg,#1C1608 0%,#3A2A08 50%,#1C1608 100%);
      padding:10px 24px; display:flex; align-items:center;
      justify-content:center; gap:10px; z-index:10;
    }
    .top-band span { color:var(--gold); font-size:11px; font-weight:500; letter-spacing:2px; text-transform:uppercase; }
    .card {
      background:var(--white); border-radius:14px;
      box-shadow:0 8px 40px rgba(28,22,8,0.10);
      border:1px solid var(--border);
      padding:44px 36px; width:100%; max-width:460px;
      text-align:center; margin-top:50px;
      animation:fadeUp .5s ease both;
    }
    .result-icon {
      width:80px; height:80px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      margin:0 auto 24px;
      animation:popIn .4s cubic-bezier(.34,1.56,.64,1) both;
    }
    .r-success { background:var(--green-l); }
    .r-pending { background:#FFF8E1; }
    .r-error   { background:#FDEDEB; }
    .r-loading { background:var(--gold-l); }
    h2 {
      font-family:'Cormorant Garamond',serif;
      font-size:30px; font-weight:600; margin-bottom:10px;
    }
    p { font-size:14px; color:var(--muted); line-height:1.7; font-weight:300; }
    .pill {
      display:inline-block; font-size:12px; font-weight:600;
      letter-spacing:1px; padding:6px 18px;
      border-radius:100px; margin:16px 0;
    }
    .pill-success { background:var(--saffron-l); color:var(--saffron-d); }
    .pill-pending { background:#FFF8E1; color:#B45309; }
    .checklist { background:var(--green-l); border-radius:10px; padding:15px 18px; margin:18px 0; text-align:left; }
    .check-item { display:flex; align-items:center; gap:9px; font-size:13px; color:var(--green); padding:5px 0; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:13px 28px; border:none; border-radius:8px;
      font-family:'Jost',sans-serif; font-size:14px; font-weight:600;
      cursor:pointer; margin-top:20px; text-decoration:none;
      background:linear-gradient(135deg,var(--saffron),var(--saffron-d));
      color:white; transition:all .2s;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(232,118,43,.3); }
    .spin-wrap { display:flex; flex-direction:column; align-items:center; gap:16px; }
    .spinner {
      width:40px; height:40px; border:3px solid var(--border);
      border-top-color:var(--saffron); border-radius:50%;
      animation:spinning .7s linear infinite;
    }
    .footer { margin-top:24px; font-size:11px; color:var(--muted); text-align:center; }
    .footer a { color:var(--saffron); text-decoration:none; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    @keyframes popIn  { from{opacity:0;transform:scale(.5)} to{opacity:1;transform:scale(1)} }
    @keyframes spinning { to{transform:rotate(360deg)} }
  </style>
</head>
<body>

<div class="top-band">
  <span>ü™∑</span>
  <span>ISKCON Centre Orai ‚Äî Nitya Seva</span>
  <span>ü™∑</span>
</div>

<div class="card" id="card">
  <!-- Loading state while we parse the response -->
  <div class="spin-wrap" id="stateLoading">
    <div class="spinner"></div>
    <p>Processing your registration‚Ä¶</p>
  </div>

  <!-- Success -->
  <div id="stateSuccess" style="display:none">
    <div class="result-icon r-success">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#2D6A3F" opacity=".15"/>
        <path d="M12 20l6 6 10-10" stroke="#2D6A3F" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h2>Hare Krishna! üôè</h2>
    <p>Your Nitya Seva has been registered successfully. The Lord will receive your offering as scheduled.</p>
    <div class="pill pill-success" id="mandateId">Mandate ID: ‚Äî</div>
    <div class="checklist">
      <div class="check-item">‚úÖ Bank account verified &amp; linked</div>
      <div class="check-item">‚úÖ Recurring seva scheduled</div>
      <div class="check-item">‚úÖ Confirmation SMS sent to your mobile</div>
    </div>
    <p style="font-size:12px">You may cancel this mandate anytime via your bank's net banking portal.</p>
    <a href="/" class="btn">Register Another Seva</a>
  </div>

  <!-- Pending -->
  <div id="statePending" style="display:none">
    <div class="result-icon r-pending">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#F59E0B" opacity=".15"/>
        <path d="M20 11v9l5 5" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h2>Registration Initiated</h2>
    <p>Your seva mandate has been submitted and is being processed by your bank. You'll be notified once it's approved ‚Äî usually within 24‚Äì48 hours.</p>
    <div class="pill pill-pending" id="pendingRef">Txn Ref: ‚Äî</div>
    <p style="font-size:12px;margin-top:12px">If you don't hear back in 48 hours, contact ISKCON Centre Orai with your transaction reference.</p>
    <a href="/" class="btn">Back to Home</a>
  </div>

  <!-- Error -->
  <div id="stateError" style="display:none">
    <div class="result-icon r-error">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
        <circle cx="20" cy="20" r="19" fill="#E74C3C" opacity=".12"/>
        <path d="M14 14l12 12M26 14L14 26" stroke="#E74C3C" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <h2>Registration Failed</h2>
    <p id="errDetail">The mandate registration could not be completed. Please try again.</p>
    <a href="/" class="btn">Try Again</a>
  </div>
</div>

<div class="footer">
  Powered by <a href="https://www.worldline.com" target="_blank">Worldline</a> &nbsp;¬∑&nbsp; ISKCON Centre Orai ¬© 2025
</div>

<script>
// Worldline POSTs response as form data in the "msg" field
// Format: txn_status|txn_msg|txn_err_msg|clnt_txn_ref|tpsl_bank_cd|
//         tpsl_txn_id|txn_amt|clnt_rqst_meta|tpsl_txn_time|bal_amt|
//         card_id|alias_name|BankTransactionID|mandate_reg_no|token|hash

function show(id) {
  ['stateLoading','stateSuccess','statePending','stateError']
    .forEach(s => document.getElementById(s).style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

function parseResponse() {
  // Method 1: Check if Worldline posted "msg" via form POST
  // Since we're a static page, Worldline may redirect with msg in URL params
  // or the responseHandler JS callback already handled it on the previous page.

  const params = new URLSearchParams(window.location.search);
  const msgParam = params.get('msg');

  if (msgParam) {
    processMsg(msgParam);
    return;
  }

  // Method 2: Check sessionStorage (set by responseHandler on main page)
  const stored = sessionStorage.getItem('wl_response');
  if (stored) {
    sessionStorage.removeItem('wl_response');
    processMsg(stored);
    return;
  }

  // Method 3: Check if page was loaded via POST (msg in body)
  // For static hosting, Worldline may send a redirect with msg appended
  // In this case show a generic "check with bank" message
  setTimeout(() => {
    show('statePending');
    document.getElementById('pendingRef').textContent = 'Please check your bank for confirmation';
  }, 1500);
}

function processMsg(msg) {
  const parts = msg.split('|');
  // txn_status is index 0
  const status      = parts[0];
  const errMsg      = parts[2] || '';
  const txnRef      = parts[3] || '‚Äî';
  const mandateNo   = parts[13] || parts[5] || '‚Äî';

  if (status === '0300') {
    document.getElementById('mandateId').textContent = 'Mandate ID: ' + mandateNo;
    show('stateSuccess');
  } else if (status === '0398' || status === '0396') {
    document.getElementById('pendingRef').textContent = 'Txn Ref: ' + txnRef;
    show('statePending');
  } else {
    document.getElementById('errDetail').textContent =
      errMsg || 'Registration failed (code: ' + status + '). Please try again.';
    show('stateError');
  }
}

// Run on page load
parseResponse();
</script>
</body>
</html>
